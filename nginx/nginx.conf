events {}

http {
    # Allow very large uploads (up to ~4 GB)
    client_max_body_size 4G;

    # Optional but nice
    sendfile on;

    # OpenWebUI Server Block
    server {
        listen 443 ssl;
        server_name openwebui.mac.stargate.lan;

        ssl_certificate     /etc/nginx/certs/openwebui+cyoa.pem;
        ssl_certificate_key /etc/nginx/certs/openwebui+cyoa-key.pem;

        # Keep connections alive a long time
        keepalive_timeout 3600s;

        location / {
            proxy_pass http://open-webui:8080;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            # Disable proxy buffering for streaming
            proxy_buffering off;

            # Aggressive "no timeout" posture for long uploads + long ASR runs
            client_body_timeout 86400s;   # 24 hours to finish sending request body
            proxy_read_timeout  86400s;   # 24 hours waiting for upstream response
            proxy_send_timeout  86400s;   # 24 hours to send data to upstream
            send_timeout        86400s;   # 24 hours while sending response to client
        }
    }

    # CYOA Django Server Block
    server {
        listen 443 ssl;
        server_name cyoa.mac.stargate.lan;

        ssl_certificate     /etc/nginx/certs/openwebui+cyoa.pem;
        ssl_certificate_key /etc/nginx/certs/openwebui+cyoa-key.pem;

        # Keep connections alive
        keepalive_timeout 300s;
        
        # Allow large audio uploads (up to 200MB for 10 minute recordings)
        client_max_body_size 200m;

        location / {
            proxy_pass http://cyoa-game-server:8000;

            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            # Standard timeouts
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
        }
        
        # STT endpoints need longer timeouts for transcription
        location /api/stt/ {
            proxy_pass http://cyoa-game-server:8000;

            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            # Longer timeouts for audio upload and transcription
            client_body_timeout 600s;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
            
            # Disable buffering for large uploads
            proxy_request_buffering off;
        }

        # Static files for Django admin
        location /static/ {
            proxy_pass http://cyoa-game-server:8000/static/;
            proxy_set_header Host $host;
        }
    }
}

