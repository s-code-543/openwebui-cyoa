version: "3.9"

services:
  # Ollama runs natively on Mac via `brew install ollama`
  # Access at: http://host.docker.internal:11434
  
  # Whisper.cpp runs natively via LaunchAgent
  # Access at: http://host.docker.internal:10300

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    expose:
      - "8080"
    volumes:
      - webui-data:/app/backend/data
      - webui-logs:/app/backend/logs
    environment:
      # Native Ollama on Mac
      OLLAMA_BASE_URL: "http://host.docker.internal:11434"
      
      WEBUI_SECRET_KEY: "change-me-to-a-long-random-string"
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}

      # Native Whisper.cpp STT on Mac (port 10300)
      AUDIO_STT_ENGINE: "openai"
      AUDIO_STT_OPENAI_API_BASE_URL: "http://host.docker.internal:10300/v1"
      AUDIO_STT_OPENAI_API_KEY: "sk-123"
      AUDIO_STT_MODEL: "large-v3-turbo"
      
      # Disable aggressive voice activity detection - wait for manual stop
      AUDIO_STT_VAD_ENABLED: "false"
      # Increase max recording time (in seconds, default is 30)
      AUDIO_MAX_RECORDING_TIME: "600"
    networks:
      - cyoa-network

  # CYOA Game Server
  cyoa-game-server:
    build: ./cyoa-game-server
    container_name: cyoa-game-server
    restart: unless-stopped
    expose:
      - "8000"
    ports:
      - "5678:5678"  # debugpy remote debugging
    environment:
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:-change-me-to-a-long-random-string}
      DJANGO_DEBUG: "1"
      PYTHONUNBUFFERED: "1"
      # Allow connections from Nginx and host for debugging
      DJANGO_ALLOWED_HOSTS: "cyoa.mac.stargate.lan,localhost,127.0.0.1,cyoa-game-server,host.docker.internal"
      # Ollama connection
      OLLAMA_URL: "http://host.docker.internal:11434"
    volumes:
      - ./cyoa-game-server:/app
      - ./cyoa_prompts:/story_prompts  # Story prompt files
      - cyoa-db:/app/db  # Persist SQLite database
    networks:
      - cyoa-network

  openwebui-ssl:
    image: nginx:alpine
    container_name: openwebui-ssl
    restart: unless-stopped
    depends_on:
      - open-webui
      - cyoa-game-server
    ports:
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/certs:ro
    networks:
      - cyoa-network

networks:
  cyoa-network:
    driver: bridge

volumes:
  webui-data:
  webui-logs:
  cyoa-db:  # SQLite database persistence
