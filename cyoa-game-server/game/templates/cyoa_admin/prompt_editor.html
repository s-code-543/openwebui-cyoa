{% extends "cyoa_admin/base.html" %}

{% block page_title %}{% if prompt %}Edit Prompt{% else %}New Prompt{% endif %}{% endblock %}

{% block extra_head %}
<!-- EasyMDE Markdown Editor -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
{% endblock %}

{% block content %}
<div class="px-4 sm:px-0">
    <div class="mb-4">
        <a href="{% url 'admin:prompt_list' %}" class="text-indigo-600 hover:text-indigo-900 text-sm font-medium">
            &larr; Back to Prompts
        </a>
    </div>

    {% if prompt %}
    <!-- Version Selector and Info -->
    <div class="bg-white shadow rounded-lg mb-6 p-4">
        <div class="flex justify-between items-start">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">{{ prompt.name }}</h2>
                <p class="text-sm text-gray-500">Type: {{ prompt.prompt_type }}</p>
                {% if prompt.file_path %}
                <p class="text-xs text-indigo-600 mt-1">File: {{ prompt.file_path }}</p>
                {% endif %}
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Switch Version</label>
                <select onchange="if(this.value) window.location.href=this.value" 
                        class="block w-full max-w-xs rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    {% for v in versions %}
                    <option value="{% url 'admin:prompt_editor' v.id %}" {% if v.id == prompt.id %}selected{% endif %}>
                        v{{ v.version }} - {{ v.description|truncatewords:8|default:"No description" }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="post" class="space-y-6">
        {% csrf_token %}
        
        <div class="bg-white shadow rounded-lg p-6">
            {% if not prompt %}
            <!-- New Prompt Fields -->
            <div class="mb-6">
                <label for="prompt_type" class="block text-sm font-medium text-gray-700 mb-2">Prompt Type *</label>
                <select name="prompt_type" id="prompt_type" required
                        class="block w-full max-w-xs rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    {% for type_code, type_name in prompt_types %}
                    <option value="{{ type_code }}">{{ type_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-6">
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Prompt Name *</label>
                <input type="text" name="name" id="name" required
                       placeholder="e.g., haunted-house-prompt, correct_refusal"
                       class="block w-full max-w-md rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <p class="mt-1 text-xs text-gray-500">Use lowercase with hyphens or underscores. This becomes part of the filename.</p>
            </div>
            {% endif %}

            <!-- Description -->
            <div class="mb-6">
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                    Description
                </label>
                <input type="text" name="description" id="description" 
                       value="{{ prompt.description }}"
                       placeholder="Brief description of this prompt version"
                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>

            <!-- Prompt Text Editor -->
            <div class="mb-4">
                <label for="prompt_text" class="block text-sm font-medium text-gray-700 mb-2">
                    Prompt Text *
                </label>
                
                <textarea name="prompt_text" id="prompt_text" required
                          style="min-height: 400px;"
                          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm font-mono">{{ prompt.prompt_text }}</textarea>
                
                <p class="mt-2 text-sm text-gray-500" id="editor_info">
                    <span id="char_count">{{ prompt.prompt_text|length|default:0 }}</span> characters
                </p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex justify-between items-center flex-wrap gap-3">
                <div class="flex flex-wrap gap-3">
                    {% if prompt %}
                    <button type="submit" name="action" value="save"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                        Save Changes
                    </button>
                    <button type="submit" name="action" value="save_new_version"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50">
                        Save as New Version
                    </button>
                    <button type="submit" name="action" value="save_to_disk"
                            class="inline-flex items-center px-4 py-2 border border-green-300 text-sm font-medium rounded-md shadow-sm text-green-700 bg-green-50 hover:bg-green-100">
                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Save to Disk
                    </button>
                    {% else %}
                    <button type="submit" name="action" value="create"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                        Create Prompt
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Initialize EasyMDE if available, otherwise fallback to basic textarea
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('prompt_text');
    const charCount = document.getElementById('char_count');
    const editorInfo = document.getElementById('editor_info');
    
    if (typeof EasyMDE !== 'undefined') {
        // EasyMDE loaded successfully
        try {
            const easyMDE = new EasyMDE({
                element: textarea,
                spellChecker: false,
                autofocus: false,
                minHeight: '400px',
                status: ['lines', 'words', 'cursor'],
                toolbar: [
                    'bold', 'italic', 'heading', '|',
                    'quote', 'unordered-list', 'ordered-list', '|',
                    'link', 'code', '|',
                    'preview', 'side-by-side', 'fullscreen', '|',
                    'guide'
                ],
                placeholder: 'Enter your prompt text here...',
                renderingConfig: {
                    singleLineBreaks: false,
                    codeSyntaxHighlighting: true,
                }
            });
            
            // Update character count
            function updateCharCount() {
                const text = easyMDE.value();
                charCount.textContent = text.length;
            }
            
            easyMDE.codemirror.on('change', updateCharCount);
            updateCharCount();
            
            // Update info text
            editorInfo.innerHTML = '<span id="char_count">' + charCount.textContent + 
                                   '</span> characters · EasyMDE editor loaded';
            
        } catch (error) {
            console.error('EasyMDE initialization failed:', error);
            fallbackToBasicEditor();
        }
    } else {
        // EasyMDE not available, use basic editor
        fallbackToBasicEditor();
    }
    
    function fallbackToBasicEditor() {
        // Basic textarea functionality
        textarea.style.resize = 'vertical';
        
        // Auto-expand
        function autoExpand() {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }
        
        // Character counter
        textarea.addEventListener('input', function() {
            charCount.textContent = textarea.value.length;
            autoExpand();
        });
        
        autoExpand();
        editorInfo.innerHTML = '<span id="char_count">' + charCount.textContent + 
                               '</span> characters · Basic editor (EasyMDE unavailable)';
    }
});</script>
{% endblock %}
