{% extends "cyoa_admin/base.html" %}

{% block title %}{% if config %}Edit{% else %}New{% endif %} Configuration{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">{% if config %}Edit Configuration{% else %}New Configuration{% endif %}</h1>
</div>

<div class="bg-white shadow-md rounded-lg p-6">
    <form method="POST" class="space-y-6">
        {% csrf_token %}
        <input type="hidden" name="action" value="save">
        
        <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Configuration Name *</label>
            <input type="text" name="name" id="name" required
                   value="{% if config %}{{ config.name }}{% endif %}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
            <textarea name="description" id="description" rows="2"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{% if config %}{{ config.description }}{% endif %}</textarea>
        </div>
        
        <div class="border-t border-gray-200 pt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Adventure Settings</h3>
            
            <div class="mb-4">
                <label for="adventure_prompt" class="block text-sm font-medium text-gray-700 mb-2">Adventure Prompt *</label>
                <select name="adventure_prompt" id="adventure_prompt" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Select Adventure --</option>
                    {% for prompt in adventure_prompts %}
                    <option value="{{ prompt.id }}"
                            {% if config and config.adventure_prompt.id == prompt.id %}selected{% endif %}>
                        {{ prompt.description }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-4">
                <label for="total_turns" class="block text-sm font-medium text-gray-700 mb-2">Game Length *</label>
                <select name="total_turns" id="total_turns" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="5" {% if config and config.total_turns == 5 %}selected{% endif %}>5 turns (Quick test)</option>
                    <option value="10" {% if config and config.total_turns == 10 %}selected{% elif not config %}selected{% endif %}>10 turns (Standard)</option>
                    <option value="15" {% if config and config.total_turns == 15 %}selected{% endif %}>15 turns (Extended)</option>
                    <option value="20" {% if config and config.total_turns == 20 %}selected{% endif %}>20 turns (Epic)</option>
                </select>
            </div>
            
            <div class="mb-4 bg-blue-50 p-4 rounded-md">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">Game Pacing (Turns per Phase)</h4>
                <p class="text-xs text-gray-600 mb-3">Customize how many turns are spent in each phase of the adventure:</p>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="phase1_turns" class="block text-xs font-medium text-gray-700 mb-1">
                            Phase 1: Introduction/Exposition
                        </label>
                        <input type="number" name="phase1_turns" id="phase1_turns" required min="1"
                               value="{% if config %}{{ config.phase1_turns }}{% else %}3{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="phase2_turns" class="block text-xs font-medium text-gray-700 mb-1">
                            Phase 2: Victory/Loss Conditions
                        </label>
                        <input type="number" name="phase2_turns" id="phase2_turns" required min="1"
                               value="{% if config %}{{ config.phase2_turns }}{% else %}3{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="phase3_turns" class="block text-xs font-medium text-gray-700 mb-1">
                            Phase 3: Progress/Twists
                        </label>
                        <input type="number" name="phase3_turns" id="phase3_turns" required min="1"
                               value="{% if config %}{{ config.phase3_turns }}{% else %}3{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="phase4_turns" class="block text-xs font-medium text-gray-700 mb-1">
                            Phase 4: Finale Setup
                        </label>
                        <input type="number" name="phase4_turns" id="phase4_turns" required min="1"
                               value="{% if config %}{{ config.phase4_turns }}{% else %}1{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Total: <span id="pacing_total" class="font-semibold">10</span> turns</p>
            </div>
            
            <div>
                <label for="storyteller_model" class="block text-sm font-medium text-gray-700 mb-2">
                    Storyteller Model *
                    <button type="button" class="refresh-models-btn ml-2 text-blue-600 hover:text-blue-800 text-xs">
                        ↻ Refresh
                    </button>
                </label>
                <select name="storyteller_model" id="storyteller_model" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Select Model --</option>
                    <optgroup label="Local Models (Ollama)">
                        {% for model in ollama_models %}
                        <option value="{{ model }}"
                                {% if config and config.storyteller_model == model %}selected{% endif %}>
                            {{ model }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    {% if external_models %}
                    <optgroup label="External Models">
                        {% for model in external_models %}
                        <option value="{{ model.model_identifier }}"
                                {% if config and config.storyteller_model == model.model_identifier %}selected{% endif %}>
                            {{ model.name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    {% endif %}
                </select>
            </div>
            
            <div class="mt-4">
                <label for="storyteller_timeout" class="block text-sm font-medium text-gray-700 mb-2">
                    Storyteller Timeout (seconds) *
                </label>
                <input type="number" name="storyteller_timeout" id="storyteller_timeout" required min="1" max="300"
                       value="{% if config %}{{ config.storyteller_timeout }}{% else %}30{% endif %}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="mt-1 text-sm text-gray-500">How long to wait for story generation (1-300 seconds)</p>
            </div>
        </div>
        
        <div class="border-t border-gray-200 pt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Judge Settings</h3>
            
            <div class="mb-4">
                <label for="judge_prompt" class="block text-sm font-medium text-gray-700 mb-2">Judge Prompt *</label>
                <select name="judge_prompt" id="judge_prompt" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Select Judge Prompt --</option>
                    {% for prompt in judge_prompts %}
                    <option value="{{ prompt.id }}"
                            {% if config and config.judge_prompt.id == prompt.id %}selected{% endif %}>
                        Judge v{{ prompt.version }}{% if prompt.description %}: {{ prompt.description }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="judge_model" class="block text-sm font-medium text-gray-700 mb-2">
                    Judge Model *
                    <button type="button" class="refresh-models-btn ml-2 text-blue-600 hover:text-blue-800 text-xs">
                        ↻ Refresh
                    </button>
                </label>
                <select name="judge_model" id="judge_model" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Select Model --</option>
                    <optgroup label="Local Models (Ollama)">
                        {% for model in ollama_models %}
                        <option value="{{ model }}"
                                {% if config and config.judge_model == model %}selected{% endif %}>
                            {{ model }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    {% if external_models %}
                    <optgroup label="External Models">
                        {% for model in external_models %}
                        <option value="{{ model.model_identifier }}"
                                {% if config and config.judge_model == model.model_identifier %}selected{% endif %}>
                            {{ model.name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    {% endif %}
                </select>
            </div>
            
            <div class="mt-4">
                <label for="judge_timeout" class="block text-sm font-medium text-gray-700 mb-2">
                    Judge Timeout (seconds) *
                </label>
                <input type="number" name="judge_timeout" id="judge_timeout" required min="1" max="300"
                       value="{% if config %}{{ config.judge_timeout }}{% else %}30{% endif %}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="mt-1 text-sm text-gray-500">How long to wait for judge validation (1-300 seconds)</p>
            </div>
            
            <div class="mt-4">
                <label for="difficulty" class="block text-sm font-medium text-gray-700 mb-2">
                    Difficulty Profile
                </label>
                <select name="difficulty" id="difficulty"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">None (no difficulty modifiers)</option>
                    {% for diff in difficulties %}
                    <option value="{{ diff.id }}"
                            {% if config and config.difficulty_id == diff.id %}selected{% endif %}>
                        {{ diff.name }}{% if diff.description %} - {{ diff.description|truncatewords:8 }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
                <p class="mt-1 text-sm text-gray-500">
                    Optional: Apply a difficulty curve that increases death probability over time.
                    <a href="{% url 'admin:difficulty_list' %}" class="text-indigo-600 hover:text-indigo-800" target="_blank">Manage difficulty profiles</a>
                </p>
            </div>
            
            <div class="mt-4">
                <label for="game_ending_prompt" class="block text-sm font-medium text-gray-700 mb-2">
                    Game Ending Prompt
                </label>
                <select name="game_ending_prompt" id="game_ending_prompt"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Use active game-ending prompt (default)</option>
                    {% for prompt in game_ending_prompts %}
                    <option value="{{ prompt.id }}"
                            {% if config and config.game_ending_prompt_id == prompt.id %}selected{% endif %}>
                        Game Ending v{{ prompt.version }}{% if prompt.description %}: {{ prompt.description }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
                <p class="mt-1 text-sm text-gray-500">
                    Prompt used when difficulty system triggers death/failure. Leave blank to use the active game-ending prompt.
                </p>
            </div>
        </div>
        
        <div class="flex justify-between pt-6 border-t border-gray-200">
            <a href="{% url 'admin:config_list' %}" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Save Configuration
            </button>
        </div>
    </form>
</div>

<script>
const pacingDefaults = {
    5: {phase1: 1, phase2: 1, phase3: 2, phase4: 1},
    10: {phase1: 3, phase2: 3, phase3: 3, phase4: 1},
    15: {phase1: 4, phase2: 5, phase3: 4, phase4: 2},
    20: {phase1: 5, phase2: 6, phase3: 6, phase4: 3}
};

function updatePacingDefaults() {
    const totalTurns = parseInt(document.getElementById('total_turns').value);
    const defaults = pacingDefaults[totalTurns];
    
    if (defaults) {
        document.getElementById('phase1_turns').value = defaults.phase1;
        document.getElementById('phase2_turns').value = defaults.phase2;
        document.getElementById('phase3_turns').value = defaults.phase3;
        document.getElementById('phase4_turns').value = defaults.phase4;
        updatePacingTotal();
    }
}

function updatePacingTotal() {
    const phase1 = parseInt(document.getElementById('phase1_turns').value) || 0;
    const phase2 = parseInt(document.getElementById('phase2_turns').value) || 0;
    const phase3 = parseInt(document.getElementById('phase3_turns').value) || 0;
    const phase4 = parseInt(document.getElementById('phase4_turns').value) || 0;
    const total = phase1 + phase2 + phase3 + phase4;
    document.getElementById('pacing_total').textContent = total;
}

// Add event listeners to update total when phase values change
document.addEventListener('DOMContentLoaded', function() {
    ['phase1_turns', 'phase2_turns', 'phase3_turns', 'phase4_turns'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePacingTotal);
    });
    updatePacingTotal();
    
    // Add event listener for total_turns change
    const totalTurnsSelect = document.getElementById('total_turns');
    if (totalTurnsSelect) {
        totalTurnsSelect.addEventListener('change', updatePacingDefaults);
    }
    
    // Add event listeners for refresh buttons
    document.querySelectorAll('.refresh-models-btn').forEach(btn => {
        btn.addEventListener('click', refreshModels);
    });
});

async function refreshModels() {
    const storytellerSelect = document.getElementById('storyteller_model');
    const judgeSelect = document.getElementById('judge_model');
    const currentStoryteller = storytellerSelect.value;
    const currentJudge = judgeSelect.value;
    
    try {
        const response = await fetch('{% url "admin:refresh_models" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        });
        
        if (!response.ok) throw new Error('Failed to refresh models');
        
        const data = await response.json();
        
        // Update storyteller dropdown (only Ollama models)
        const storytellerOllama = storytellerSelect.querySelector('optgroup[label="Local Models (Ollama)"]');
        if (storytellerOllama) {
            storytellerOllama.innerHTML = '';
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                if (model === currentStoryteller) option.selected = true;
                storytellerOllama.appendChild(option);
            });
        }
        
        // Update judge dropdown (only Ollama models)
        const judgeOllama = judgeSelect.querySelector('optgroup[label="Local Models (Ollama)"]');
        if (judgeOllama) {
            judgeOllama.innerHTML = '';
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                if (model === currentJudge) option.selected = true;
                judgeOllama.appendChild(option);
            });
        }
        
        alert('Models refreshed successfully!');
    } catch (error) {
        alert('Error refreshing models: ' + error.message);
    }
}
</script>
{% endblock %}
