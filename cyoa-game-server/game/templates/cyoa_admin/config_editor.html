{% extends "cyoa_admin/base.html" %}

{% block title %}{% if config %}Edit{% else %}New{% endif %} Configuration{% endblock %}
{% block page_title %}{% if config %}Edit Configuration{% else %}New Configuration{% endif %}{% endblock %}

{% block content %}
<div class="bg-white shadow-md rounded-lg p-4 sm:p-6">
    <form method="POST" class="space-y-6" autocomplete="off" onsubmit="return validatePacing();">
        {% csrf_token %}
        <input type="hidden" name="action" value="save">
        
        <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Configuration Name *</label>
            <input type="text" name="name" id="name" required
                   value="{% if config %}{{ config.name }}{% endif %}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
            <textarea name="description" id="description" rows="2"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{% if config %}{{ config.description }}{% endif %}</textarea>
        </div>
        
        <div class="border-t border-gray-200 pt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Adventure Settings</h3>
            
            <div class="mb-4">
                <label for="adventure_prompt" class="block text-sm font-medium text-gray-700 mb-2">Adventure Prompt *</label>
                <select name="adventure_prompt" id="adventure_prompt" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Select Adventure --</option>
                    {% for prompt in adventure_prompts %}
                    <option value="{{ prompt.id }}"
                            {% if config and config.adventure_prompt.id == prompt.id %}selected{% endif %}>
                        {{ prompt.name }}{% if prompt.description %}: {{ prompt.description }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-4">
                <label for="total_turns" class="block text-sm font-medium text-gray-700 mb-2">Game Length *</label>
                <select name="total_turns" id="total_turns" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="5" {% if config and config.total_turns == 5 %}selected{% endif %}>5 turns (Quick test)</option>
                    <option value="10" {% if config and config.total_turns == 10 %}selected{% elif not config %}selected{% endif %}>10 turns (Standard)</option>
                    <option value="15" {% if config and config.total_turns == 15 %}selected{% endif %}>15 turns (Extended)</option>
                    <option value="20" {% if config and config.total_turns == 20 %}selected{% endif %}>20 turns (Epic)</option>
                </select>
            </div>
            
            <div class="mb-4 bg-blue-50 p-4 rounded-md">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">Game Pacing (Turns per Phase)</h4>
                <p class="text-xs text-gray-600 mb-3">Customize how many turns are spent in each phase of the adventure:</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label for="phase1_turns" class="block text-xs font-medium text-gray-700 mb-1">
                            Phase 1: Introduction/Exposition
                        </label>
                        <input type="number" name="phase1_turns" id="phase1_turns" required min="1"
                               value="{% if config %}{{ config.phase1_turns }}{% else %}3{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="phase2_turns" class="block text-xs font-medium text-gray-700 mb-1">
                            Phase 2: Victory/Loss Conditions
                        </label>
                        <input type="number" name="phase2_turns" id="phase2_turns" required min="1"
                               value="{% if config %}{{ config.phase2_turns }}{% else %}3{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="phase3_turns" class="block text-xs font-medium text-gray-700 mb-1">
                            Phase 3: Progress/Twists
                        </label>
                        <input type="number" name="phase3_turns" id="phase3_turns" required min="1"
                               value="{% if config %}{{ config.phase3_turns }}{% else %}3{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="phase4_turns" class="block text-xs font-medium text-gray-700 mb-1">
                            Phase 4: Finale Setup
                        </label>
                        <input type="number" name="phase4_turns" id="phase4_turns" required min="1"
                               value="{% if config %}{{ config.phase4_turns }}{% else %}1{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Total: <span id="pacing_total" class="font-semibold">10</span> turns</p>
            </div>
            
            <div class="mb-4">
                <label for="storyteller_model" class="block text-sm font-medium text-gray-700 mb-2">
                    Storyteller Model *
                    <button type="button" class="refresh-models-btn ml-2 text-blue-600 hover:text-blue-800 text-xs">
                        â†» Refresh
                    </button>
                </label>
                <select name="storyteller_model" id="storyteller_model" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Select Model --</option>
                    {% regroup all_models by provider as models_by_provider %}
                    {% for provider_group in models_by_provider %}
                    <optgroup label="{{ provider_group.grouper.name }}">
                        {% for model in provider_group.list %}
                        <option value="{{ model.id }}"
                                {% if config and config.storyteller_model.id == model.id %}selected{% endif %}>
                            {{ model.name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-4">
                <label for="storyteller_timeout" class="block text-sm font-medium text-gray-700 mb-2">
                    Storyteller Timeout (seconds) *
                </label>
                <input type="number" name="storyteller_timeout" id="storyteller_timeout" required min="1" max="300"
                       value="{% if config %}{{ config.storyteller_timeout }}{% else %}30{% endif %}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="mt-1 text-sm text-gray-500">How long to wait for story generation (1-300 seconds)</p>
            </div>
            
            <div class="mb-4">
                <label for="difficulty" class="block text-sm font-medium text-gray-700 mb-2">
                    Difficulty Profile
                </label>
                <select name="difficulty" id="difficulty"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">None (no difficulty modifiers)</option>
                    {% for diff in difficulties %}
                    <option value="{{ diff.id }}"
                            {% if config and config.difficulty_id == diff.id %}selected{% endif %}>
                        {{ diff.name }}{% if diff.description %} - {{ diff.description|truncatewords:8 }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
                <p class="mt-1 text-sm text-gray-500">
                    Optional: Apply a difficulty curve that increases death probability over time.
                    <a href="{% url 'admin:difficulty_list' %}" class="text-indigo-600 hover:text-indigo-800" target="_blank">Manage difficulty profiles</a>
                </p>
            </div>
            
            <div>
                <label for="game_ending_prompt" class="block text-sm font-medium text-gray-700 mb-2">
                    Game Ending Prompt *
                </label>
                <select name="game_ending_prompt" id="game_ending_prompt" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Select Game Ending Prompt --</option>
                    {% for prompt in game_ending_prompts %}
                    <option value="{{ prompt.id }}"
                            {% if config and config.game_ending_prompt_id == prompt.id %}selected{% endif %}>
                        {{ prompt.name }} v{{ prompt.version }}{% if prompt.description %}: {{ prompt.description }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
                <p class="mt-1 text-sm text-gray-500">
                    Prompt used when difficulty system triggers death/failure.
                </p>
            </div>
        </div>
        
        <div class="border-t border-gray-200 pt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">ðŸš« Refusal Detection & Turn Correction</h3>
            
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="enable_refusal_detection" id="enable_refusal_detection" value="1"
                           {% if not config or config.enable_refusal_detection %}checked{% endif %}
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">
                        Enable automatic refusal detection & correction
                    </span>
                </label>
                <p class="mt-1 ml-6 text-sm text-gray-500">
                    Automatically detect when the storyteller refuses to generate a valid turn and regenerate a corrected replacement.
                </p>
            </div>
            
            <div id="refusal-settings" {% if config and not config.enable_refusal_detection %}style="display: none;"{% endif %}>
                <div class="mb-4 pl-6 border-l-4 border-blue-200">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Classification Settings</h4>
                    
                    <div class="mb-4">
                        <label for="classifier_prompt" class="block text-sm font-medium text-gray-700 mb-2">
                            Classifier Prompt *
                        </label>
                        <select name="classifier_prompt" id="classifier_prompt"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 refusal-required">
                            <option value="">-- Select Classifier Prompt --</option>
                            {% for prompt in classifier_prompts %}
                            <option value="{{ prompt.id }}"
                                    {% if config and config.classifier_prompt_id == prompt.id %}selected{% endif %}>
                                {{ prompt.name }} v{{ prompt.version }}{% if prompt.description %}: {{ prompt.description }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">
                            Prompt used to classify responses as refusals or valid turns.
                        </p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="classifier_model" class="block text-sm font-medium text-gray-700 mb-2">
                            Classifier Model *
                            <button type="button" class="refresh-models-btn ml-2 text-blue-600 hover:text-blue-800 text-xs">
                                â†» Refresh
                            </button>
                        </label>
                        <select name="classifier_model" id="classifier_model"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 refusal-required">
                            <option value="">-- Select Model --</option>
                            {% regroup all_models by provider as models_by_provider %}
                            {% for provider_group in models_by_provider %}
                            <optgroup label="{{ provider_group.grouper.name }}">
                                {% for model in provider_group.list %}
                                <option value="{{ model.id }}"
                                        {% if config and config.classifier_model and config.classifier_model.id == model.id %}selected{% endif %}>
                                    {{ model.name }}
                                </option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">
                            Fast, lightweight model for binary classification (e.g., gemma3:270m).
                        </p>
                    </div>
                    
                    <div>
                        <label for="classifier_timeout" class="block text-sm font-medium text-gray-700 mb-2">
                            Classifier Timeout (seconds)
                        </label>
                        <input type="number" name="classifier_timeout" id="classifier_timeout" min="1" max="60"
                               value="{% if config %}{{ config.classifier_timeout }}{% else %}10{% endif %}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-gray-500">
                            Classification should be fast (1-60 seconds). Use a small model for best performance.
                        </p>
                    </div>
                    
                    <div>
                        <label for="classifier_question" class="block text-sm font-medium text-gray-700 mb-2">
                            Classifier Question
                        </label>
                        <textarea name="classifier_question" id="classifier_question" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{% if config %}{{ config.classifier_question }}{% else %}Is this a content policy refusal?{% endif %}</textarea>
                        <p class="mt-1 text-sm text-gray-500">
                            Question asked to the classifier along with the story turn text. Keep it clear and specific.
                        </p>
                    </div>
                </div>
                
                <div class="pl-6 border-l-4 border-blue-200">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Turn Correction Settings</h4>
                    
                    <div class="mb-4">
                        <label for="turn_correction_prompt" class="block text-sm font-medium text-gray-700 mb-2">Turn Correction Prompt *</label>
                        <select name="turn_correction_prompt" id="turn_correction_prompt" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 refusal-required">
                            <option value="">-- Select Turn Correction Prompt --</option>
                            {% for prompt in turn_correction_prompts %}
                            <option value="{{ prompt.id }}"
                                    {% if config and config.turn_correction_prompt.id == prompt.id %}selected{% endif %}>
                                {{ prompt.name }} v{{ prompt.version }}{% if prompt.description %}: {{ prompt.description }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">Prompt for correcting refused or problematic turns (Turn 2+)</p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="game_ending_turn_correction_prompt" class="block text-sm font-medium text-gray-700 mb-2">Game-Ending Turn Correction Prompt *</label>
                        <select name="game_ending_turn_correction_prompt" id="game_ending_turn_correction_prompt" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 refusal-required">
                            <option value="">-- Select Game-Ending Correction Prompt --</option>
                            {% for prompt in game_ending_turn_correction_prompts %}
                            <option value="{{ prompt.id }}"
                                    {% if config and config.game_ending_turn_correction_prompt_id == prompt.id %}selected{% endif %}>
                                {{ prompt.name }} v{{ prompt.version }}{% if prompt.description %}: {{ prompt.description }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">Specific prompt for correcting refused game-ending (death) turns.</p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="turn_correction_model" class="block text-sm font-medium text-gray-700 mb-2">
                            Turn Correction Model *
                            <button type="button" class="refresh-models-btn ml-2 text-blue-600 hover:text-blue-800 text-xs">
                                â†» Refresh
                            </button>
                        </label>
                        <select name="turn_correction_model" id="turn_correction_model" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 refusal-required">
                            <option value="">-- Select Model --</option>
                            {% regroup all_models by provider as models_by_provider %}
                            {% for provider_group in models_by_provider %}
                            <optgroup label="{{ provider_group.grouper.name }}">
                                {% for model in provider_group.list %}
                                <option value="{{ model.id }}"
                                        {% if config and config.turn_correction_model.id == model.id %}selected{% endif %}>
                                    {{ model.name }}
                                </option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="turn_correction_timeout" class="block text-sm font-medium text-gray-700 mb-2">
                            Turn Correction Timeout (seconds) *
                        </label>
                        <input type="number" name="turn_correction_timeout" id="turn_correction_timeout" required min="1" max="300"
                               value="{% if config %}{{ config.turn_correction_timeout }}{% else %}30{% endif %}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-gray-500">How long to wait for turn correction (1-300 seconds)</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex justify-between pt-6 border-t border-gray-200">
            <a href="{% url 'admin:config_list' %}" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Save Configuration
            </button>
        </div>
    </form>
</div>

<script>
const pacingDefaults = {
    5: {phase1: 1, phase2: 1, phase3: 2, phase4: 1},
    10: {phase1: 3, phase2: 3, phase3: 3, phase4: 1},
    15: {phase1: 4, phase2: 5, phase3: 4, phase4: 2},
    20: {phase1: 5, phase2: 6, phase3: 6, phase4: 3}
};

// Toggle refusal detection settings
document.getElementById('enable_refusal_detection').addEventListener('change', function() {
    const settings = document.getElementById('refusal-settings');
    const isEnabled = this.checked;
    settings.style.display = isEnabled ? 'block' : 'none';
    
    // Toggle required attribute on refusal fields
    const refusalFields = document.querySelectorAll('.refusal-required');
    refusalFields.forEach(field => {
        if (isEnabled) {
            field.setAttribute('required', 'required');
        } else {
            field.removeAttribute('required');
        }
    });
});

function updatePacingDefaults() {
    const totalTurns = parseInt(document.getElementById('total_turns').value);
    const defaults = pacingDefaults[totalTurns];
    
    if (defaults) {
        document.getElementById('phase1_turns').value = defaults.phase1;
        document.getElementById('phase2_turns').value = defaults.phase2;
        document.getElementById('phase3_turns').value = defaults.phase3;
        document.getElementById('phase4_turns').value = defaults.phase4;
        updatePacingTotal();
    }
}

function updatePacingTotal() {
    const phase1 = parseInt(document.getElementById('phase1_turns').value) || 0;
    const phase2 = parseInt(document.getElementById('phase2_turns').value) || 0;
    const phase3 = parseInt(document.getElementById('phase3_turns').value) || 0;
    const phase4 = parseInt(document.getElementById('phase4_turns').value) || 0;
    const total = phase1 + phase2 + phase3 + phase4;
    
    const totalSpan = document.getElementById('pacing_total');
    totalSpan.textContent = total;

    // Check against header setting
    const globalTotal = parseInt(document.getElementById('total_turns').value) || 0;
    if (total === globalTotal) {
        totalSpan.className = "font-semibold text-green-600";
    } else {
        totalSpan.className = "font-semibold text-red-600";
    }
}

function validatePacing() {
    const phase1 = parseInt(document.getElementById('phase1_turns').value) || 0;
    const phase2 = parseInt(document.getElementById('phase2_turns').value) || 0;
    const phase3 = parseInt(document.getElementById('phase3_turns').value) || 0;
    const phase4 = parseInt(document.getElementById('phase4_turns').value) || 0;
    const total = phase1 + phase2 + phase3 + phase4;
    
    // Check against header setting
    const globalTotal = parseInt(document.getElementById('total_turns').value) || 0;
    
    if (total !== globalTotal) {
        alert("The sum of turns in the Game Pacing section (" + total + ") must equal the Game Length (" + globalTotal + ").\n\nPlease adjust the phase durations.");
        return false;
    }
    return true;
}

// Add event listeners to update total when phase values change
document.addEventListener('DOMContentLoaded', function() {
    ['phase1_turns', 'phase2_turns', 'phase3_turns', 'phase4_turns'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePacingTotal);
    });
    updatePacingTotal();
    
    // Add event listener for total_turns change
    const totalTurnsSelect = document.getElementById('total_turns');
    if (totalTurnsSelect) {
        totalTurnsSelect.addEventListener('change', updatePacingDefaults);
    }
    
    // Add event listeners for refresh buttons
    document.querySelectorAll('.refresh-models-btn').forEach(btn => {
        btn.addEventListener('click', refreshModels);
    });
});

async function refreshModels() {
    const storytellerSelect = document.getElementById('storyteller_model');
    const turnCorrectionSelect = document.getElementById('turn_correction_model');
    const classifierSelect = document.getElementById('classifier_model');
    const currentStoryteller = storytellerSelect.value;
    const currentTurnCorrection = turnCorrectionSelect.value;
    const currentClassifier = classifierSelect ? classifierSelect.value : '';
    
    try {
        const response = await fetch('{% url "admin:refresh_models" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        });
        
        if (!response.ok) throw new Error('Failed to refresh models');
        
        const data = await response.json();
        
        // Update storyteller dropdown (only Ollama models)
        const storytellerOllama = storytellerSelect.querySelector('optgroup[label="Local Models (Ollama)"]');
        if (storytellerOllama) {
            storytellerOllama.innerHTML = '';
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                if (model === currentStoryteller) option.selected = true;
                storytellerOllama.appendChild(option);
            });
        }
        
        // Update judge dropdown (only Ollama models)
        const judgeOllama = judgeSelect.querySelector('optgroup[label="Local Models (Ollama)"]');
        if (judgeOllama) {
            judgeOllama.innerHTML = '';
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                if (model === currentJudge) option.selected = true;
                judgeOllama.appendChild(option);
            });
        }
        
        alert('Models refreshed successfully!');
    } catch (error) {
        alert('Error refreshing models: ' + error.message);
    }
}
</script>
{% endblock %}
